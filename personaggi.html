<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XRi - Selezione Eroe</title>
    <script src="https://xri.onl/XRi.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden; background-color: #000;
            font-family: 'Segoe UI', sans-serif; color: white;
        }

        #fantasy-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('assets/img/background.png');
            background-size: cover; background-position: center;
            filter: brightness(0.3); z-index: 1;
        }

        #ui-layer {
            position: relative; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 0%, rgba(0,0,0,0.4) 100%);
        }

        h1 { font-size: 3rem; text-shadow: 0 0 20px #00d1ff; margin: 0; }
        .map-name { font-size: 2.5rem; color: #00d1ff; margin-top: 20px; font-weight: bold; min-height: 4rem; }
        
        .btn-confirm {
            display: none; /* Appare solo dopo la scelta */
            margin-top: 40px; padding: 20px 80px; font-size: 1.8rem;
            background: #00ff44; color: black; border: none; border-radius: 50px;
            font-weight: bold; cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 30px rgba(0, 255, 68, 0.5);
        }

        #debug-overlay {
            display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; 
            background:rgba(0,0,0,0.95); z-index:9999; padding:40px; 
            color: #00ff00; font-family: monospace; overflow-y: auto; 
            border: 10px solid red; font-size: 2rem;
        }
    </style>
</head>
<body>

    <div id="fantasy-bg"></div>

    <div id="ui-layer">
        <h1 id="title-text">TOCCA L'EROE PER SCEGLIERE</h1>
        <div class="map-name" id="choice-text"></div>
        <button class="btn-confirm" id="btn-confirm" onclick="confirmChoice()">CONFERMA SCELTA</button>
        
        <div id="debug-overlay">
            <button onclick="document.getElementById('debug-overlay').style.display='none'">CHIUDI</button>
            <div id="debug-content"></div>
        </div>
    </div>

    <script>
    const RAW_HERO_BASE = "https://raw.githubusercontent.com/simonevetere/XRi-game-example/main/assets/3d/playable/";
    const heroes = [
        { id: 'archer', name: 'ARCHER', glb: RAW_HERO_BASE + 'archer.glb', x: -0.2 },
        { id: 'knight', name: 'KNIGHT', glb: RAW_HERO_BASE + 'knight.glb', x: 0.0 },
        { id: 'troll', name: 'TROLL', glb: RAW_HERO_BASE + 'troll.glb', x: 0.2 }
    ];

    let selectedHeroId = null;
    let heroInstances = {};

    // 1. Funzione di Log (integrata con XRi.js come abbiamo discusso)
    function log(msg, color = "#00ff00") {
        console.log(msg);
        const content = document.getElementById('debug-content');
        if(content) {
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            content.insertBefore(entry, content.firstChild);
        }
    }

    // 2. Spawn Simultaneo
    async function spawnAllHeroes() {
        log("Evocazione eroi...");
        XRi.clearAll();

        for (const hero of heroes) {
            log(`Spawning ${hero.name}...`);
            // Spawna a 10cm di distanza l'uno dall'altro (asse X)
            const inst = await XRi.spawn(hero.id, hero.glb, 0.1, { x: hero.x, y: 1, z: 0.5 });
            await inst.resetRotation(0);
            await inst.setGrabbable(true);
            await inst.startAnimation("");
            heroInstances[hero.id] = inst;
        }
        log("Tutti gli eroi sono pronti.");
    }

    window.addEventListener('vuplexready', () => {
        window.vuplex.addEventListener('message', (e) => {
            try {
                const data = JSON.parse(e.data);
                // Quando l'utente tocca/afferra un oggetto, Unity manda il comando GRAB o SELECT
                if (data.type === "GRAB_START" || data.type === "OBJECT_SELECTED") {
                    handleSelection(data.id);
                }
            } catch(err) {}
        });
    });

    async function handleSelection(heroId) {
        if (selectedHeroId) return; // Scelta giÃ  effettuata
        
        selectedHeroId = heroId;
        const heroData = heroes.find(h => h.id === heroId);
        
        document.getElementById('title-text').innerText = "HAI SCELTO:";
        document.getElementById('choice-text').innerText = heroData.name;
        document.getElementById('btn-confirm').style.display = 'block';

        log(`Selezionato: ${heroData.name}`, "#ffff00");

        // Elimina gli altri due
        for (const hero of heroes) {
            if (hero.id !== heroId) {
                // Comando ipotetico per distruggere singolo oggetto o lo spostiamo lontano
                XRi._send({ command: "DESTROY_OBJECT", id: hero.id });
            }
        }

        // Porta quello scelto al centro e raddrizzalo
        const chosen = heroInstances[heroId];
        await chosen.setPosition({ x: 0, y: 1, z: 0.5 }, 0.5);
    }

    function confirmChoice() {
        log("Scelta confermata! Caricamento mappa...");
        // Qui puoi mandare al server multiplayer la scelta o cambiare pagina
        window.location.href = "mappa.html?hero=" + selectedHeroId;
    }

    window.onload = () => {
        const init = () => {
            XRi.initMultiplayer();
            spawnAllHeroes();
        };
        if (window.XRi && XRi.isReady) init();
        else window.addEventListener('vuplexready', init);
    };
</script>
</body>
</html>