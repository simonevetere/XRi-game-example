<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Selezione Eroe AR</title>
    <script src="https://xri.onl/XRi.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden; background-color: #000;
            font-family: 'Segoe UI', sans-serif; color: white;
        }

        /* SFONDO FANTASY CON IMMAGINE */
        #fantasy-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('assets/img/background.png');
            background-size: cover; background-position: center;
            filter: brightness(0.4) blur(8px); 
            z-index: 1;
        }

        #ui-header { 
            position: relative; z-index: 10;
            text-align: center; padding: 40px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); 
        }

        h1 { font-size: 3rem; text-shadow: 0 0 20px #00ffcc; margin: 0; }

        #confirm-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(10, 10, 10, 0.95); border: 3px solid #00ffcc;
            padding: 50px; border-radius: 20px; text-align: center; z-index: 100;
            box-shadow: 0 0 50px rgba(0, 255, 204, 0.4);
        }

        .btn-group { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
        .btn { padding: 15px 40px; font-size: 1.2rem; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-yes { background: #00ffcc; color: black; }
        .btn-no { background: #333; color: white; }
        .btn:active { transform: scale(0.95); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="fantasy-bg"></div>

    <div id="ui-header">
        <h1>TOCCA IL TUO EROE</h1>
        <button class="btn btn-yes" style="position: fixed; top: 2%; right: 2%; padding: 10px 25px; font-size: 1rem;" onclick="window.location.reload()">reload</button>
    </div>

    <div id="confirm-box" class="hidden">
        <h2 id="char-name-display" style="color:#00ffcc; text-transform: uppercase;">---</h2>
        <p>Vuoi iniziare l'avventura con questo eroe?</p>
        <div class="btn-group">
            <button class="btn btn-no" onclick="cancelChoice()">ANNULLA</button>
            <button class="btn btn-yes" onclick="confirmChoice()">CONFERMA</button>
        </div>
    </div>

    <script>
        // URL Base per i personaggi dal tuo GitHub
        const HERO_BASE = "https://raw.githubusercontent.com/simonevetere/XRi-game-example/main/assets/3d/playable/";
        
        let heroes = { knight: null, troll: null, archer: null };
        let selectedHero = null;

        const urlParams = new URLSearchParams(window.location.search);
        const mapFile = urlParams.get('map') || 'swamp_location.glb';

        async function initScene() {
            if(window.XRi) {
                XRi.initMultiplayer();
                XRi.clearAll();
                // La mappa arriva come URL completo dalla pagina precedente o usa il default
                XRi.spawn("map", mapFile, 0.8);

                setTimeout(async () => {
                    // SPAWN E SALVATAGGIO ISTANZE dai percorsi GitHub
                    heroes.knight = XRi.spawn("knight", HERO_BASE + "knight.glb", 1.2);
                    heroes.troll = XRi.spawn("troll", HERO_BASE + "troll.glb", 1.2);
                    heroes.archer = XRi.spawn("archer", HERO_BASE + "archer.glb", 1.2);

                    // POSIZIONAMENTO
                    await heroes.knight.move({ x: -2.0, y: 0, z: 3.5 });
                    await heroes.troll.move({ x: 0, y: 0, z: 4.0 });
                    await heroes.archer.move({ x: 2.0, y: 0, z: 3.5 });

                    // ANIMAZIONI (Passiamo stringa vuota per default)
                    heroes.knight.startAnimation("");
                    heroes.troll.startAnimation("");
                    heroes.archer.startAnimation("");
                }, 1000);
            }
        }

        function handleUnityMessage(e) {
            try {
                const d = JSON.parse(e.data);
                if (d.command === "UNITY_LOG" && d.type === "GRAB_START") {
                    const id = d.id;
                    if (heroes[id]) {
                        selectedHero = heroes[id];
                        selectedHero.startAnimation(""); // Trigger animazione default al tocco
                        
                        const names = { knight: "Guerriero", troll: "Troll", archer: "Arciere" };
                        document.getElementById('char-name-display').innerText = names[id];
                        document.getElementById('confirm-box').classList.remove('hidden');
                    }
                }
            } catch(err) {}
        }

        // Setup Vuplex
        if (window.vuplex) {
            window.vuplex.addEventListener('message', handleUnityMessage);
        } else {
            window.addEventListener('vuplexready', () => {
                window.vuplex.addEventListener('message', handleUnityMessage);
            });
        }

        function cancelChoice() {
            if (selectedHero) selectedHero.startAnimation("");
            selectedHero = null;
            document.getElementById('confirm-box').classList.add('hidden');
        }

        async function confirmChoice() {
            // Elimina gli altri eroi
            for (let key in heroes) {
                if (heroes[key] && heroes[key] !== selectedHero) {
                    heroes[key].destroy();
                }
            }
            
            selectedHero.startAnimation("");
            document.getElementById('confirm-box').innerHTML = "<h2>AVVENTURA INIZIATA!</h2>";
            
            setTimeout(() => {
                document.body.style.display = 'none';
            }, 3000);
        }

        window.onload = initScene;
    </script>
</body>
</html>